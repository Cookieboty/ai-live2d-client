# Live2D模型手臂重叠问题分析

**日期**: 2025-05-27  
**问题**: Live2D模型出现多只手臂重叠，类似穿模现象

## 问题描述

用户反馈在Live2D模型显示中，某些模型会出现4只手臂的情况，看起来像是两个图层拼接在一起，产生穿模的视觉效果。

## 问题分析

根据网络搜索和项目代码分析，这个问题主要有以下几个可能的原因：

### 1. 模型制作问题（最可能）

**原因**: 模型本身在制作时就存在多个手臂部件，这是Live2D模型制作中的常见设计：

- **多姿态设计**: 为了支持不同的动作和表情，模型制作者会创建多个手臂部件（如举手、放下、挥手等不同姿态）
- **Pose系统**: Live2D使用Pose系统来控制哪些部件在特定时间显示，通过`pose.json`文件定义部件组

**证据**: 项目中的pose.json文件显示了这种设计模式：
```json
{
  "type":"Live2D Pose",
  "parts_visible":[
    {
      "group":[
        {"id":"PARTS_ARM_R_1"},
        {"id":"PARTS_ARM_R_2"}
      ]
    },
    {
      "group":[
        {"id":"PARTS_ARM_L_1"},
        {"id":"PARTS_ARM_L_2"}
      ]
    }
  ]
}
```

### 2. 绘制顺序问题

**原因**: Live2D中的Art Mesh绘制顺序不正确导致重叠显示：

- **Draw Order**: 每个Art Mesh都有绘制顺序值（0-1000），值越大越在前景
- **Draw Order Group**: 可以将部件设置为绘制顺序组，统一管理层级
- **全局vs局部顺序**: 当多个模型重叠时，可能出现绘制顺序冲突

### 3. Pose系统未正确加载

**原因**: 模型的Pose配置文件未正确加载或解析：

- **缺失pose.json**: 如果模型没有正确的pose配置，所有手臂部件可能同时显示
- **Pose参数错误**: pose.json中的部件ID或组配置错误
- **SDK兼容性**: 不同版本的Live2D SDK对Pose系统的支持可能有差异

### 4. 模型版本兼容性问题

**原因**: Cubism 2.1和3.0+版本之间的差异：

- **三角化算法**: 不同版本使用不同的网格三角化算法
- **绘制方式**: 新版本的绘制方式可能与旧模型不兼容
- **参数系统**: 参数控制方式的变化可能导致部件显示异常

## 解决方案

### 1. 检查Pose系统加载

在`useLive2DModel.ts`中确保正确加载pose配置：

```typescript
// 检查是否正确加载了pose.json文件
const poseResponse = await customFetch(`${modelPath}/pose.json`);
const poseConfig = await poseResponse.json();
```

### 2. 验证绘制顺序

在模型加载后检查Art Mesh的绘制顺序设置：

```typescript
// 确保手臂部件的绘制顺序正确设置
// 可以通过调整Draw Order值来解决重叠问题
```

### 3. 模型文件检查

检查具体出现问题的模型文件：
- 验证pose.json文件是否存在且格式正确
- 检查模型的Art Mesh命名是否与pose配置匹配
- 确认模型版本与当前SDK的兼容性

### 4. 添加调试信息

在模型加载过程中添加更多日志，帮助定位问题：

```typescript
console.log('Pose配置:', poseConfig);
console.log('当前显示的部件:', visibleParts);
console.log('Art Mesh绘制顺序:', drawOrders);
```

## 结论

这个问题最可能是**模型制作时的正常设计**，通过Pose系统来控制不同手臂部件的显示。如果出现多只手臂同时显示，主要原因是：

1. **Pose系统未正确工作** - 需要检查pose.json的加载和解析
2. **绘制顺序冲突** - 需要调整Art Mesh的Draw Order设置
3. **模型兼容性问题** - 可能需要更新模型文件或调整SDK设置

建议优先检查Pose系统的加载情况，这是最常见的解决方案。

## 代码更新记录

### 2025-05-27 更新

根据问题分析，发现项目中的Pose系统实现不完整，进行了以下更新：

#### 1. 修复Live2DFramework.ts中的loadPose方法

**问题**: 原来的`loadPose`方法是空实现，没有真正加载和应用Pose配置。

**解决方案**: 
- 实现了完整的Pose加载逻辑，支持两种模式：
  - 如果支持`window.L2DPose`，使用官方API加载
  - 如果不支持，使用手动解析pose.json的方式
- 添加了`applyManualPose`方法，手动解析pose.json并应用部件显示规则

**代码变更**:
```typescript
// 检查是否支持L2DPose
if (typeof window !== 'undefined' && window.L2DPose) {
  pm.loadBytes(path, (buf: ArrayBuffer) => {
    try {
      this.pose = window.L2DPose.load(buf);
      logger.info('Pose loaded successfully: ' + path);
      
      // 立即应用pose设置，确保正确的部件显示
      if (this.pose && this.live2DModel) {
        this.pose.updateParam(this.live2DModel);
        logger.info('Pose applied to model');
      }
    } catch (error) {
      logger.warn('Failed to load pose: ' + error);
      this.pose = null;
    }
    
    if (typeof callback === 'function') callback();
  });
} else {
  // 手动解析pose.json并应用
  logger.info('L2DPose not available, attempting manual pose parsing');
  pm.loadBytes(path, (buf: ArrayBuffer) => {
    try {
      const poseData = pm.jsonParseFromBytes(buf);
      this.applyManualPose(poseData);
      logger.info('Manual pose applied: ' + path);
    } catch (error) {
      logger.warn('Failed to parse pose manually: ' + error);
    }
    
    if (typeof callback === 'function') callback();
  });
}
```

#### 2. 添加手动Pose应用逻辑

**功能**: 当Live2D SDK不支持官方Pose API时，手动解析pose.json文件并应用部件显示规则。

**实现原理**:
- 解析pose.json中的`parts_visible`配置
- 对于每个部件组，只显示第一个部件，隐藏其他部件
- 通过`setPartsOpacity`方法控制部件透明度

#### 3. 增强模型初始化过程

**改进**: 在模型初始化完成后立即应用Pose配置，确保从一开始就显示正确的部件状态。

**代码变更**:
```typescript
// 确保Pose系统在模型初始化完成后立即应用
if (this.pose != null && this.live2DModel) {
  this.pose.updateParam(this.live2DModel);
  logger.info('Pose system applied after model initialization');
}
```

#### 4. 添加调试日志

**目的**: 帮助诊断Pose系统的工作状态，便于后续问题排查。

**位置**: 
- 模型更新循环中的Pose应用
- 模型初始化完成后的Pose应用
- Pose加载成功/失败的状态记录

### 预期效果

通过这些更新，应该能够解决Live2D模型手臂重叠的问题：

1. **正确的部件显示**: Pose系统将确保在每个部件组中只显示一个部件
2. **兼容性提升**: 支持不同版本的Live2D SDK，包括不支持官方Pose API的情况
3. **调试能力**: 通过日志可以清楚地看到Pose系统的工作状态

### 测试建议

1. 重新加载出现手臂重叠问题的模型
2. 检查浏览器控制台中的Pose相关日志
3. 验证模型是否只显示一组手臂部件
4. 测试不同的模型以确保兼容性

## 下一步行动

1. ✅ **已完成**: 实现完整的Pose系统加载和应用逻辑
2. ✅ **已完成**: 添加调试日志帮助问题诊断
3. **待测试**: 验证修复效果，测试不同模型的兼容性
4. **待优化**: 根据测试结果进一步优化Pose系统的实现 
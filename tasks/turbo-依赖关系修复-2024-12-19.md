# Turborepo 依赖关系修复 - 2024-12-19

## 问题描述

用户发现 Turborepo 的 build 任务没有完成就开始执行 package 任务，导致：
1. `@ig-live/renderer:build` 的 vite 构建还在进行中
2. `@ig-live/electron:package` 已经开始复制文件
3. 复制失败，因为 renderer 的构建产物还没有完成

## 问题分析

### 原始配置问题

1. **重复执行 build**：
   ```json
   "package:prod": "npm run build && electron-builder build"
   ```
   - electron 的 package 脚本内部又调用了 build
   - 导致即使 Turborepo 执行了 build，package 还会再次执行

2. **依赖关系不精确**：
   ```json
   "package": {
     "cache": false,
     "dependsOn": ["build"]
   }
   ```
   - 只依赖自己的 build，没有考虑跨包依赖
   - electron 的 package 需要 renderer 的构建产物

3. **缺少 package 脚本**：
   - renderer 和 types 包没有 package 脚本
   - 导致 Turborepo 显示 `<NONEXISTENT>` 命令

## 修复方案

### 1. 移除重复的 build 调用

修改 `packages/electron/package.json`：
```json
// 修改前
"package:prod": "npm run build && electron-builder build"

// 修改后  
"package:prod": "electron-builder build"
```

### 2. 添加缺失的 package 脚本

为 renderer 和 types 包添加 package 脚本：
```json
// packages/renderer/package.json
"package": "echo 'Renderer build completed, no packaging needed'"

// packages/types/package.json  
"package": "echo 'Types build completed, no packaging needed'"
```

### 3. 精确配置依赖关系

修改 `turbo.json`，使用包级别的精确依赖：
```json
{
  "tasks": {
    "@ig-live/electron#package": {
      "cache": false,
      "dependsOn": ["@ig-live/electron#build", "@ig-live/renderer#build"]
    },
    "@ig-live/renderer#package": {
      "cache": false,
      "dependsOn": ["@ig-live/renderer#build"]
    },
    "@ig-live/types#package": {
      "cache": false,
      "dependsOn": ["@ig-live/types#build"]
    }
  }
}
```

## 修复结果

### 正确的执行顺序
1. `@ig-live/types:build` 首先执行
2. `@ig-live/electron:build` 和 `@ig-live/renderer:build` 并行执行
3. `@ig-live/renderer:build` 完成 vite 构建
4. `@ig-live/electron:package` 开始执行
5. 文件复制成功，打包完成

### 验证结果
- ✅ 依赖关系正确
- ✅ 不再重复执行 build
- ✅ 文件复制成功
- ✅ 最终打包成功：`智能小助手-1.0.0-arm64.dmg`

## 关键学习点

1. **Turborepo 依赖配置**：
   - 使用 `^build` 表示依赖所有依赖包的 build
   - 使用 `@package#task` 可以精确指定跨包依赖

2. **避免重复执行**：
   - 包脚本不应该重复执行 Turborepo 已经管理的任务
   - 分离构建和打包的职责

3. **完整性检查**：
   - 所有包都应该有对应的任务脚本
   - 即使是空操作也要明确定义 